{% extends 'base.html' %}
{% block content %}

<div class="content">
  <!-- если есть результат -->
  {% if trackers %}
  <h1 style="text-align: center;margin-bottom: 20px;">Your created trackers</h1>
  <div class="container">
    <!-- Начало цикла для всех трекеров -->
    {% for tracker in trackers %}
    <div class="row bg-secondary rounded mb-3 py-3 grey-box">
      <!-- Текст поиска слева -->
      <div class="col-sm-2">
        <h3
          class="position-relative top-50 start-50 translate-middle text-center text-light text-limit"
        >
          {{ tracker.search_text }}
        </h3>
      </div>
      <div class="col-sm-6">
        <ul class="list-group list-group-flush text-center" id="job_trackers">
          <!-- 3 навыка и их количество появлений -->
          {% if parsers[tracker.id] %} {% for skill in
          skills[parsers[tracker.id].id][0:3] %}
          <li class="bg-secondary list-group-item text-light">
            {{ skill.name }} - {{ skill.amount }}
          </li>
          {% endfor %} {% else %}
          <li class="bg-secondary list-group-item text-light">
            Data is still uploading
          </li>
          <li class="bg-secondary list-group-item text-light">Please wait</li>
          <li class="bg-secondary list-group-item text-light">...</li>
          {% endif %}
        </ul>
      </div>
      <!-- правая часть квадрата. Количество парсеров и шестеренка -->
      <div class="col-sm-2">
        <h5
          class="position-relative top-50 start-50 translate-middle text-center text-light text-border"
        >
          {% if parsers[tracker.id] %} Vacancies amount
          <br />
          {{parsers[tracker.id].amount_of_vacancies}} {% else %}
          <img
            style="width: 50px; height: 50px"
            src="{{ static('loading.gif') }}"
          />
          {% endif %}
        </h5>
      </div>
      <div class="col-sm-2">

        <button style="border-radius: 10px" type="button" data-bs-toggle="modal" data-bs-target="#trackerModal{{ tracker.id }}" id="modalBtn{{tracker.id}}" onclick="load_parser_data({{ tracker.id }})" class="position-relative top-50 start-50 translate-middle">
          <img id="settingsImg{{ tracker.id }}" style="width: 60px; height: 60px" src="{{ static('settings.png') }}"/>

        </button>
      </div>
    </div>
    {% endfor %}
    <div class="row rounded py-3">
      <div class="col-sm-4">

        <button
          data-bs-toggle="modal"
          data-bs-target="#createTrackerModal"
          class="btn btn-success py-3 px-4 btn-margin"
        >

          <h4 class="add-tracker">Add tracker</h4>
        </button>
      </div>
    </div>
  </div>

  <!-- если результата нет-->
  {% else %}
  <!-- если чел зареган -->
  {% if request.user.is_authenticated %}
  <div class="welcome">
    <h1>
      Seems like you don`t tracking jobs yet
    </h1>
    <h2 style="text-align: center; cursor: pointer" class="text-primary">
      <a data-bs-toggle="modal" data-bs-target="#createTrackerModal"
        >Start tracking</a
      >
    </h2>
  </div>
  <!-- если чел НЕ зареган-->
  {% else %}
  <div class="welcome">
    <h1>To create your own job skills tracker,</h1>
    <h2>
      you need to

      <a href="{{ url('login') }}">Log in</a>
      <span>or</span>
      <a href="{{ url('registration') }}">Sign up</a>
    </h2>
    <h1 style="text-align: center; cursor: pointer" class="text-primary"></h1>
  </div>
  {% endif %} {% endif %}
</div>

<!-- subscribed trackers -->
{% if subscribed_trackers %}

<h1 style="text-align: center;margin-bottom: 20px;margin-top: 20px;">Your subscribed trackers</h1>


<div class="container">
  <!-- Начало цикла для всех трекеров -->
  {% for tracker in subscribed_trackers %}
  <div class="row bg-secondary rounded mb-3 py-3 grey-box">
    <!-- Текст поиска слева -->
    <div class="col-sm-2">
      <h2
        class="position-relative top-50 start-50 translate-middle text-center text-light text-limit"
      >
        {{ tracker.search_text }}
      </h2>
    </div>
    <div class="col-sm-6">
      <ul class="list-group list-group-flush text-center" id="job_trackers">
        <!-- 3 навыка и их количество появлений -->
        {% if parsers[tracker.id] %} {% for skill in
        skills[parsers[tracker.id].id][0:3] %}
        <li class="bg-secondary list-group-item text-light">
          {{ skill.name }} - {{ skill.amount }}
        </li>
        {% endfor %} {% else %}
          <li class="bg-secondary list-group-item text-light">
            Data is still uploading
          </li>
          <li class="bg-secondary list-group-item text-light">Please wait</li>
          <li class="bg-secondary list-group-item text-light">...</li>
          {% endif %}
        </ul>
      </div>
      <!-- правая часть квадрата. Количество парсеров и шестеренка -->
      <div class="col-sm-2">
        <h5 class="position-relative top-50 start-50 translate-middle text-center text-light">
          {% if parsers[tracker.id] %} Vacancies amount
            <br />{{parsers[tracker.id].amount_of_vacancies}}
          {% else %}
          <div class="sherst">
            <img style="width: 50px; height: 50px" src="{{ static('loading.gif') }}"/>
          </div>
            {% endif %}
        </h5>
      </div>
      <div class="col-sm-2">
        <button style="border-radius: 10px" type="button" data-bs-toggle="modal" data-bs-target="#trackerModal{{ tracker.id }}" id="modalBtn{{tracker.id}}" onclick="load_parser_data({{ tracker.id }})" class="position-relative top-50 start-50 translate-middle">
          <img id="settingsImg{{ tracker.id }}" style="width: 60px; height: 60px" src="{{ static('settings.png') }}"/>
        </button>
      </div>
    </div>
    {% endfor %}
{% endif %}

<!-- Modals -->
<!-- Модалка создания трекера  -->
<div class="modal fade" id="createTrackerModal" tabindex="-1"  aria-labelledby="exampleModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form class="modal-form" method="POST" action="{{ url('create_tracker') }}">
        <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}"/>

        <div class="modal-header">
          <h5 class="modal-title" id="exampleModalLabel">
            Creating job skill stats tracker
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <fo class="modal-body">
          <div class="mb-3">
            <label class="form-label">Search text</label>
            <input type="text" class="form-control" name="search_text" />
            <div class="form-text">Enter a job title you want to track</div>
          </div>

          <div class="mb-3">
            <label class="form-label">Exclude from search</label>
            <input type="text" class="form-control" name="exclude_from_search"/>
            <div class="form-text">
              Enter text that you don`t want to see in job description. Divide each parameter with comma
            </div>
          </div>

          <div class="mb-3">
            <label class="form-label">Select your areas to search</label><br>
            <select class="js-example-basic-multiple" id="createTrackerArea" multiple="multiple" style="width:100%" name="area[]">
              <option value="">Everywhere</option>
                {% for area in areas %}
                  <option value="{{area.hh_id}}">{{area.name}}</option>
                {% endfor %}
            </select>
          </div>
          <div class="form-group">
            <div class="form-left">
              <p>Тип занятости</p>
              <label for="full-time"><input type="checkbox" value="full-time" name="employment-type">Полная занятость</label>
              <label for="partial"><input type="checkbox" value="partial" name="employment-type">Частичная занятость</label>
              <label for="project"><input type="checkbox" value="project" name="employment-type">Проектная работа</label>
              <label for="volunteering"><input type="checkbox" value="volunteering" name="employment-type">Волонтерство</label>
              <label for="internship"><input type="checkbox" value="internship" name="employment-type">Стажировка</label>
            </div>
            <p>График работы</p>
            <label for="full-day"><input type="checkbox" value="full-day" name="timetable">Полный день</label>
            <label for="remote"><input type="checkbox" value="remote" name="timetable">Удаленная работа</label>
            <label for="flexible"><input type="checkbox" value="flexible" name="timetable">Гибкий график</label>
            <label for="replaceable"><input type="checkbox" value="replaceable" name="timetable">Сменный график</label>
            <label for="shift"><input type="checkbox" value="shift" name="timetable">Вахтовый метод</label>
            <p>Опыт работы</p>
            <label for="doesnt-matter"><input type="radio" id="doesnt-matter" name="work-experience">Не имеет значения</label>
            <label for="from-3-to-6-years-old"><input type="radio" id="from-3-to-6-years-old" name="work-experience">От 3 до 6 лет</label>
            <label for="from-1-to-3-years"><input type="radio" id="from-1-to-3-years" name="work-experience">От 1 года до 3 лет</label>
            <label for="no-experience"><input type="radio" id="no-experience" name="work-experience">Нет опыта</label>
            <label for="over-6-years"><input type="radio" id="over-6-years" name="work-experience">Более 6 лет</label>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
            Close
          </button>
          <button type="submit" class="btn btn-primary">Create</button>
        </div>
      </form>
    </div>
  </div>
</div>
  </div>


<!-- модалка каждого трекера -->
{% for tracker in list(trackers) + subscribed_trackers %}
  <div class="modal fade" id="trackerModal{{ tracker.id }}" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h4 class="modal-title headline-limit"><a href="{{ tracker.hh_url }}">{{ tracker.search_text }}</a></h4>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          {% if request.user.id == tracker.user_creator %}
            <div class="mb-3">
              <h6 class="text-success" id="succ_text_{{tracker.id}}" style="display: none">
                Job tracker updated successfully
              </h6>
            </div>
          {% endif %}

          {% if request.user.id == tracker.user_creator.id %}
            <div class="mb-3">
              <label class="form-label">Search text</label>
              <input type="text" minlength="3" maxlength="60" id="search_text_{{tracker.id}}" value="{{tracker.search_text}}" class="form-control" name="search_text"/>
              <div class="form-text">Enter a job title you want to track</div>
            </div>
            <div class="mb-3">
              <label class="form-label">Exclude from search</label>
              <input type="text" id="exclude_from_search_{{tracker.id}}" value="{{tracker.exclude_from_search}}" class="form-control" name="exclude_from_search"/>
              <div class="form-text">Enter text that you don`t want to see in job description. Please, divide each parameter with comma</div>
            </div>
          <div class="mb-3">
            <label class="form-label">Select your areas to search</label><br>
            <select class="js-example-basic-multiple" id="updateTrackerArea{{ tracker.id }}" multiple="multiple" style="width:100%" name="area[]">
              <option value="">Everywhere</option>
                {% for area in areas %}
                  <option value="{{area.hh_id}}" {% if area.hh_id in tracker.areas %} selected {% endif %}>{{area.name}}</option>
                {% endfor %}
            </select>
          </div>
            subscribers - {{ tracker.subscribers.count() }}
          <br>
          <div class="form-group">
            <div class="form-left2">
              <p>Тип занятости</p>
              <label for="full-time"><input type="checkbox" value="full-time" name="employment-type">Полная занятость</label>
              <label for="partial"><input type="checkbox" value="partial" name="employment-type">Частичная занятость</label>
              <label for="project"><input type="checkbox" value="project" name="employment-type">Проектная работа</label>
              <label for="volunteering"><input type="checkbox" value="volunteering" name="employment-type">Волонтерство</label>
              <label for="internship"><input type="checkbox" value="internship" name="employment-type">Стажировка</label>
            </div>
            <div class="float-left">
              <p>График работы</p>
              <label for="full-day"><input type="checkbox" value="full-day" name="timetable">Полный день</label>
              <label for="remote"><input type="checkbox" value="remote" name="timetable">Удаленная работа</label>
              <label for="flexible"><input type="checkbox" value="flexible" name="timetable">Гибкий график</label>
              <label for="replaceable"><input type="checkbox" value="replaceable" name="timetable">Сменный график</label>
              <label for="shift"><input type="checkbox" value="shift" name="timetable">Вахтовый метод</label>
            </div>
            <p>Опыт работы</p>
            <label for="doesnt-matter"><input type="radio" id="doesnt-matter" name="work-experience">Не имеет значения</label>
            <label for="from-3-to-6-years-old"><input type="radio" id="from-3-to-6-years-old" name="work-experience">От 3 до 6 лет</label>
            <label for="from-1-to-3-years"><input type="radio" id="from-1-to-3-years" name="work-experience">От 1 года до 3 лет</label>
            <label for="no-experience"><input type="radio" id="no-experience" name="work-experience">Нет опыта</label>
            <label for="over-6-years"><input type="radio" id="over-6-years" name="work-experience">Более 6 лет</label>
        </div>
            <button type="button" onclick="update_tracker({{tracker.id}});" style="margin-bottom: 10px;margin-top: 10px;" class="btn btn-primary">Save</button>
            <button type="button" onclick="delete_tracker({{tracker.id}});" style="margin-bottom: 10px;margin-top: 10px;" class="btn btn-danger">Delete</button>
            
            
          {% else %}
              <div class="mb-3">
                  <h3>Текст запроса - {{tracker.search_text}}</h3>
              </div>
            {% if tracker.exclude_from_search %}
              <div class="mb-3">
                  <h4>Исключено из запроса - {{ tracker.exclude_from_search }}</h4>
              </div>
            {% endif %}
          <br>
          {% for area in areas %}
            {% if area.hh_id in tracker.areas %}
              <p>{{area.name}}</p>
            {% endif %}
          {% endfor %}
          <br>
          <button
            type="button"
            onclick="unsubscribe_from_tracker({{tracker.id}});"
            id="sub_button{{tracker.id}}"
            style=""
            class="btn btn-danger"
          >
            unsubscribe
          </button>
          <br><br>
          {% endif %}
          <div class="tracker-status" id="tracker_stats{{tracker.id}}"></div>
        </div>
      </div>
    </div>
  </div>
{% endfor %}


<!-- Scripts -->
<script>
    $('#createTrackerArea').select2({
              dropdownParent: $('#createTrackerModal')
    });
    {% for tracker in trackers %}
    $('#updateTrackerArea{{ tracker.id }}').select2({
      dropdownParent: $('#trackerModal{{ tracker.id }}')
    });
    {% endfor %}
</script>
<script>
  function load_parser_data(tracker_id) {
    $.ajax({
      url: "/load_parser_data/?tracker_id=" + tracker_id,
      method: "get",
      dataType: "html",
      success: function (data) {
        data = JSON.parse(data);
        div_to_append = document.getElementById("tracker_stats" + tracker_id);
        data.forEach((skill) => {
          let p = document.createElement("p");
          p.innerHTML = skill["name"] + ": " + skill["amount"];
          div_to_append.append(p);
        });
        btn_call = document.getElementById("modalBtn" + tracker_id).onclick =
          "";
      },
    });
  }
</script>
<script>
  function update_tracker(tracker_id) {
    $.ajax({
      url: "/update_tracker/?",
      method: "post",
      dataType: "html",
      data: {
        tracker_id: tracker_id,
        next: "{{ request.path }}",
        csrfmiddlewaretoken: "{{ csrf_token }}",
        search_text: document.getElementById("search_text_" + tracker_id).value,
        exclude_from_search: document.getElementById(
          "exclude_from_search_" + tracker_id
        ).value,
        'area[]': $('#updateTrackerArea' + tracker_id).val(),
      },
      success: function (data) {
        location.reload();
      },
    });
  }
</script>

<script>
  function delete_tracker(tracker_id) {
    delete_confirm = confirm("are you sure want to delete this tracker?");
    if (delete_confirm) {
      $.ajax({
        url: "/delete_tracker/",
        method: "post",
        dataType: "html",
        data: {
          tracker_id: tracker_id,
          csrfmiddlewaretoken: "{{ csrf_token }}",
        },
        success: function (data) {
          location.reload();
        },
      });
    }
  }
</script>
<script>
function unsubscribe_from_tracker(tracker_id) {
  $.ajax({
    url: "/unsubscribe_from_tracker/",
    method: "post",
    dataType: "html",
    data: { tracker_id: tracker_id, csrfmiddlewaretoken: "{{ csrf_token }}" },
    success: function (data) {

    },
  });
}
</script>
{% endblock %}